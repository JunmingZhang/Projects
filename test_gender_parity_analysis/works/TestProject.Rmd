---
title: "TestProject"
output:
  pdf_document: default
---

```{r setup, include=FALSE, message = FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(ggplot2)
library(reshape)
library(lattice)
# install.packages("DataExplorer")
library(DataExplorer)
library(corrplot)
library(Hmisc)
library(lme4)
library(stats)
library(MuMIn)
library(lmtest)
library(pscl)
knitr::opts_chunk$set(echo = FALSE)
```

```{r data}
black_saber_current_employees <- read_csv("./data/black-saber-current-employees.csv")
final_hire<- read_csv("./data/final-hires-newgrad_2020.csv")
phase1 <-read_csv("./data/phase1-new-grad-applicants-2020.csv") 
phase2 <-read_csv("./data/phase2-new-grad-applicants-2020.csv") 
phase3 <-read_csv("./data/phase3-new-grad-applicants-2020.csv")
```

```{r combine_phases}
phase1_2 <- inner_join(phase1, phase2, by = c("applicant_id", "team_applied_for", "cover_letter", "cv", "gpa", "gender", "extracurriculars", "work_experience"), keep=FALSE)
phase1_2_3 <- inner_join(phase1_2, phase3, by="applicant_id", keep=FALSE)
final <- phase1_2_3 %>% filter(applicant_id %in% final_hire$applicant_id)

nrow(phase1)
nrow(phase1_2)
nrow(phase1_2_3)
nrow(final)

allphase1_2 <- left_join(phase1, phase2, by = c("applicant_id", "team_applied_for", "cover_letter", "cv", "gpa", "gender", "extracurriculars", "work_experience"), keep=FALSE)
allphase1_2_3 <- left_join(allphase1_2, phase3, by="applicant_id", keep=FALSE)
```

```{r add_variables}
allphase <- allphase1_2_3 %>%
  mutate(status = ifelse(applicant_id %in% final$applicant_id, "hired", 
                         ifelse(applicant_id %in% phase1_2_3$applicant_id, "rejected at phase3",
                               ifelse(applicant_id %in% phase1_2$applicant_id, "rejected at phase2", "rejected at phase1")))) %>%
  mutate(applicant_id = as.character(applicant_id)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say")

pass_phase1 <- phase1 %>%
  mutate(result = as.numeric(applicant_id %in% phase1_2$applicant_id)) %>%
  mutate(applicant_id = as.character(applicant_id)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say")

pass_phase2 <- phase1_2 %>%
  mutate(result = as.numeric(applicant_id %in% phase1_2_3$applicant_id)) %>%
  mutate(applicant_id = as.character(applicant_id)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say")

pass_final <- phase1_2_3 %>%
  mutate(result = as.numeric(applicant_id %in% final$applicant_id)) %>%
  mutate(applicant_id = as.character(applicant_id)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say")
```

```{r eda_status, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(x = status, fill = gender), data = allphase) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males' and Females' Status in Hiring Phases",
   x = "Status",
   y = "Percentage") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

```{r eda_speaking_leadership, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(x = speaking_skills, fill = gender), data = allphase) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males' and Females' Speaking Skills in Phase 2",
   x = "Score",
   y = "Percentage") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = leadership_presence, fill = gender), data = allphase) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males' and Females' Leadership Presence in Phase 2",
   x = "Score",
   y = "Percentage") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

* Males have stronger leadership presence than females

```{r eda_writing_technical, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(y = writing_skills, x = technical_skills, color = gender), data = allphase) + 
  geom_point() +
  theme_minimal() +
  labs(title = "Males' and Females' Writing Skills and Technical Skills in Phase 2",
   x = "Technical Skills",
   y = "Writing Skills") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = writing_skills, fill = gender), data = allphase) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Writing Skills in Phase 2",
   x = "Score",
   y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = writing_skills, color = gender), data = allphase) + 
  geom_freqpoly(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Writing Skills in Phase 2",
   x = "Score",
   y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = technical_skills, fill = gender), data = allphase) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Technical Skills in Phase 2",
   x = "Score",
   y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = technical_skills, color = gender), data = allphase) + 
  geom_freqpoly(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Technical Skills in Phase 2",
   x = "Score",
   y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```


```{r eda_interview, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(y = interviewer_rating_2, x = interviewer_rating_1, color = gender), data = allphase) + 
  geom_point() +
  theme_minimal() +
  labs(title = "Males' and Females' Interview Ratings in Phase 3",
   x = "Interviewer Rating 1",
   y = "Interviewer Rating 2") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = interviewer_rating_1, fill = gender), data = allphase) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Interview Ratings 1 in Phase 3",
     x = "Score",
     y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = interviewer_rating_1, color = gender), data = allphase) + 
  geom_freqpoly(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Interview Ratings 1 in Phase 3",
     x = "Score",
     y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = interviewer_rating_2, fill = gender), data = allphase) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Interview Ratings 2 in Phase 3",
   x = "Score",
   y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = interviewer_rating_2, color = gender), data = allphase) + 
  geom_freqpoly(binwidth = 10) + 
  theme_minimal() +
  labs(title = "Males' and Females' Interview Ratings 2 in Phase 3",
     x = "Score",
     y = "Count") + 
  theme(legend.title = element_blank(), legend.position = c(.15, .8), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

## hiring model
### something here (glm(binomial), glmer)

```{r glm_glmer_pass_phase1}
#pass_phase1
#mod_1_glm <- glm(result ~ gpa+gender+extracurriculars+work_experience, family=binomial, data=pass_phase1)
#mod_1_glmer <- lme4::glmer(result ~ gpa+gender+extracurriculars+work_experience+(1|applicant_id), data = pass_phase1, family = binomial, nAGQ = 0)

#summary(mod_1_glm)
#summary(mod_1_glmer)
```

```{r glm_glmer_pass_phase2}
#pass_phase2
#mod_2_glm <- glm(result ~ gpa+gender+extracurriculars+work_experience+technical_skills+writing_skills+leadership_presence+speaking_skills, family=binomial, data=pass_phase2)
#mod_2_glmer <- lme4::glmer(result ~ gpa+gender+extracurriculars+work_experience+technical_skills+writing_skills+leadership_presence+speaking_skills+(1|applicant_id), data = pass_phase2, family = binomial, nAGQ = 0)

#summary(mod_2_glm)
#summary(mod_2_glmer)
```

```{r glm_glmer_pass_phase3}
#pass_final
#mod_3_glm <- glm(result ~ gpa+gender+extracurriculars+work_experience+technical_skills+writing_skills+leadership_presence+speaking_skills+interviewer_rating_1+interviewer_rating_2, family=binomial, data=pass_final)
#mod_3_glmer <- lme4::glmer(result ~ gpa+gender+extracurriculars+work_experience+technical_skills+writing_skills+leadership_presence+speaking_skills+interviewer_rating_1+interviewer_rating_2+(1|applicant_id), data = pass_final, family = binomial, nAGQ = 0)

#summary(mod_3_glm)
#summary(mod_3_glmer)
```

## Current employees

```{r eda_current_employees, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
current_employees <- black_saber_current_employees %>%
  filter(financial_q == "2020 Q4") %>%
  mutate(salary = gsub("\\$", "", salary)) %>%
  mutate(salary = gsub("\\,", "", salary)) %>%
  mutate(salary = as.numeric(salary)) %>%
  mutate(employee_id = as.character(employee_id)) %>%
  mutate(gender = as.factor(gender)) %>%
  mutate(team = as.factor(team)) %>%
  mutate(role_seniority = as.factor(role_seniority)) %>%
  mutate(role_seniority = fct_relevel(role_seniority, "Director",  after=7)) %>%
  mutate(leadership_for_level = as.factor(leadership_for_level)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say")
  
  
plot_bar(current_employees)
plot_histogram(current_employees)
```

## gender

```{r eda_gender, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(x = leadership_for_level, fill = gender), data = current_employees) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males and Females for Levels in Leadership (2020 Q4)",
       x = "Leadership For Level",
       y = "Percentage") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = role_seniority, fill = gender), data = current_employees) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males and Females under Role Seniority (2020 Q4)",
       x = "Role Seniority",
       y = "Percentage") + 
  theme(axis.text.x = element_text(size = 9, angle = 45), 
        legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = team, fill = gender), data = current_employees) + 
  geom_bar(position = "fill") + 
  theme_minimal() +
  labs(title = "Occupation of Males and Females in Different Teams (2020 Q4)",
       x = "Team",
       y = "Percentage") + 
  theme(axis.text.x = element_text(size = 9, angle = 25), 
        legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) + 
  scale_fill_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

* We consider the employees in financial quarter 4 in 2020 as the current employees 
* People who exceed expectations are all males and people who need improvement are all females. Need exploration on whether salary depends on gender. If salary does not depend on gender, then this result is caused by the situation that female spend more time in families rather than in companies (pregnancy, etc.) so that we could observe a relatively lower productivity in female employees. Thus it could explain why we observe only females need improvement and lower salary.

## salary

```{r pd_sal_gender, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(x=gender, y=salary, color=gender), data=current_employees) +
  geom_boxplot() +
  theme_minimal() +
  labs(title="Males and felamles salary in 2020 comparison, Q4")

plot_boxplot(current_employees, by = "gender", 
             geom_boxplot_args = list("outlier.color" = "red"),
             title = "Males' and Females' Productivity and Salary in 2020 Q4",
             theme_config = list(
               "plot.title" = element_text(hjust = 0.5)))

ggplot(aes(x = productivity,y=salary, colour = gender), data = current_employees) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_minimal() +
  labs(title = "Males' and Females' Productivity and Salary in 2020 Q4",
       x = "Productivity",
       y = "Salary") + 
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

* The average of female's productivity is greater than the average of male's productivity, where the average of female's salary is less than the average of male's salary


```{r salary_gender1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(aes(x = gender,y=salary, colour = gender), data = current_employees) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(~team, nrow=2) +
  labs(title = "Males' and Females' Salary in Different Teams (2020 Q4)",
       x = "Gender",
       y = "Salary") +
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

ggplot(aes(x = gender,y=productivity, colour = gender), data = current_employees) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(~team, nrow=2) +
  labs(title = "Males' and Females' Productivity in Different Teams (2020 Q4)",
       x = "Gender",
       y = "Productivity") +
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

current_employees %>%
  mutate(role_seniority = factor(role_seniority, levels = c("Entry-level", "Junior I", "Junior II", 
                                                            "Senior I", "Senior II", "Senior III", 
                                                            "Manager", "Director", "Vice president"))) %>%
  ggplot(aes(x = gender,y=salary, colour = gender)) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(~role_seniority, nrow=2) +
  labs(title = "Males' and Females' Salary under Role Seniority (2020 Q4)",
       x = "Gender",
       y = "Salary") +
  theme(legend.title = element_blank(), legend.position = c(.9, .25), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))

current_employees %>%
  mutate(role_seniority = factor(role_seniority, levels = c("Entry-level", "Junior I", "Junior II", 
                                                            "Senior I", "Senior II", "Senior III", 
                                                            "Manager", "Director", "Vice president"))) %>%
  ggplot(aes(x = gender,y=productivity, colour = gender)) +
  geom_boxplot() +
  theme_minimal() +
  facet_wrap(~role_seniority, nrow=2) +
  labs(title = "Males' and Females' Productivity under Role Seniority (2020 Q4)",
       x = "Gender",
       y = "Productivity") + 
  theme(legend.title = element_blank(), legend.position = c(.9, .25), plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("Man" = "#003F5C", "Woman" = "#86BCB6", "Prefer not to say" = "#B9CA5D"))
```

* Grouping by the role seniority, we could observe that the average salary is increasing from Entry-level up to Vice president.
* For all the role seniority, the average of female's salary is less than the average of male's salary.
* For most teams in the company, the average of female's salary is less than the average of male's salary.
* Females have higher average salary than males have in People and talent team.

```{r salary_gender2, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
current_employees %>%
  group_by(team, gender) %>%
  summarise(mean(salary))

current_employees %>%
  mutate(role_seniority = factor(role_seniority, levels = c("Entry-level", "Junior I", "Junior II", 
                                                            "Senior I", "Senior II", "Senior III", 
                                                            "Manager", "Director", "Vice president"))) %>%
  group_by(role_seniority, gender) %>%
  summarise(mean(salary))
```

| Role Seniority| Gender| Mean(Salary)|
|--------------:|------:|------------:|
|    Entry-level|    Man|   \$32739.24|
|               |  Woman|   \$29797.92|
|       Junior I|    Man|   \$37834.78|
|               |  Woman|   \$34394.34|
|      Junior II|    Man|   \$39837.74|
|               |  Woman|   \$38135.20|
|       Senior I|    Man|   \$45973.81|
|               |  Woman|   \$43075.86|
|      Senior II|    Man|   \$51117.86|
|               |  Woman|   \$48071.43|
|     Senior III|    Man|   \$57421.88|
|               |  Woman|   \$53900.00|
|        Manager|    Man|   \$72436.84|
|               |  Woman|   \$71762.50|
|       Director|    Man|  \$121891.67|
|               |  Woman|  \$121891.67|
| Vice president|    Man|  \$152383.33|
|               |  Woman|  \$148950.00|

* table version of describing role_seniority & team

## salary model
```{r salary_gender_V0, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# use team and as random effect since it is a grouping units
# use linear mixted model, since salary continuous
# consider productivity

# we do not consider models with only gender or without grouping units, since from above factors
# 1. other factors may affect the performance
# 2. grouping units may affect
# Without consider enough factors may lead to underfitting
m1 = lmer(salary~gender + leadership_for_level + productivity + (1|team), data=current_employees)
m2 = lmer(salary~gender + leadership_for_level + productivity + (1|role_seniority), data=current_employees)
# we do not use productivity since it is negative, very weird
# this may happen because it overlaps with leadership_for_level
summary(m1)
summary(m2)
# compare models with and without productivity
m3 = lmer(salary~gender + leadership_for_level + (1|team), data=current_employees)
m4 = lmer(salary~gender + leadership_for_level + (1|role_seniority), data=current_employees)
# test result: null hypothesis rejected
# well, we should include productivity although the coefficient looks weird
# and rejection is not strong
lrtest(m3, m1)
lrtest(m4, m2)
```

```{r salary_gender_V1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# m1 = lmer(salary~gender + leadership_for_level + productivity + (1|team), data=current_employees)
# m2 = lmer(salary~gender + leadership_for_level + productivity + (1|role_seniority), data=current_employees)
# now consider team and role_senority as random slope
m3 = lmer(salary~gender + leadership_for_level + productivity + (1 + team|role_seniority), data=current_employees)
m4 = lmer(salary~gender + leadership_for_level + productivity + (1 + role_seniority|team), data=current_employees)
# summary of two models
summary(m3)
summary(m4)
# by the test result, the null hypothesis rejected
# we should use models with random slope instead of simply random intercept
lrtest(m1, m4)
lrtest(m2, m3)
```

```{r salary_gender_V2, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# compare m3 and m4 by
# 1. adjusted R^2
# 2. AIC and BIC
# by the comparison, all metrics of m4

# m3 = lmer(salary~gender + leadership_for_level + productivity + (team|role_seniority), data=current_employees)
# m4 = lmer(salary~gender + leadership_for_level + productivity + (role_seniority|team), data=current_employees)
# Based on the test result, m4 has higher marginal R^2, AIC and BIC than m4, this may indicate overfitting
# so I choose m3 here
r.squaredGLMM(m3)
r.squaredGLMM(m4)
AIC(m3)
AIC(m4)
BIC(m3)
BIC(m4)

model_salary = m3
```

```{r salary final, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# m3 = lmer(salary~gender + leadership_for_level + productivity + (team|role_seniority), data=current_employees)

# fit model without gender to see if gender is significant
model_salary_no_gender = lmer(salary~leadership_for_level + productivity + (1 + team|role_seniority), data=current_employees)

# the null hypothesis rejected, choose the complex model
# so it shows that gender may affect the salary
lrtest(model_salary_no_gender, model_salary)
model_salary_final <- model_salary
```
```{r salary model summary, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(model_salary_final)
```


1. model with gender
$$salary_{ij} = [\beta_0 + \beta_1 \cdot gender_{ij} + \beta_2 \cdot leadership\_for\_level_{ij} + \beta_3 \cdot productivity_{ij} + (\beta_4 + team_j)] + [\epsilon_{ij} + role\_seniority_j]$$,

where $$\epsilon_{ij} \sim \mathcal{N}(0,\;\sigma^2_e)$$
$$team_j \sim \mathcal{N}(0,\;\sigma^2_{team})$$,
$$role\_seniority_j \sim \mathcal{N}(0,\;\sigma^2_{role\_seniority})$$,

2. model without gender
$$salary_{ij} = [\beta_0 + \beta_1 \cdot leadership\_for\_level_{ij} + \beta_2 \cdot productivity_{ij} + (\beta_3 + team_j)] + [\epsilon_{ij} + role\_seniority_j]$$
where $$\epsilon_{ij} \sim \mathcal{N}(0,\;\sigma^2_e)$$,
$$team_j \sim \mathcal{N}(0,\;\sigma^2_{team})$$,
$$role\_seniority_j \sim \mathcal{N}(0,\;\sigma^2_{role\_seniority})$$,

## promotion

```{r promotion_gender, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
years = c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")

employees <- black_saber_current_employees %>%
  mutate(salary = gsub("\\$", "", salary)) %>%
  mutate(salary = gsub("\\,", "", salary)) %>%
  mutate(salary = as.numeric(salary)) %>%
  mutate(employee_id = as.character(employee_id)) %>%
  mutate(gender = as.factor(gender)) %>%
  mutate(team = as.factor(team)) %>%
  mutate(role_seniority = as.factor(role_seniority)) %>%
  mutate(role_seniority = fct_relevel(role_seniority, "Director",  after=7)) %>%
  mutate(leadership_for_level = as.factor(leadership_for_level)) %>%
  mutate(gender = factor(gender, levels = c("Man", "Woman", "Prefer not to say"))) %>%
  filter(gender != "Prefer not to say") %>%
  mutate(year = str_trunc(financial_q, 4, "right", "")) %>%
  group_by(employee_id) %>%
  mutate(years_of_service = sum(years %in% year))

promotion_data <- employees %>%
  group_by(employee_id) %>%
  summarise(gender, team, years_of_service, productivity, role_seniority, num_promotion = length(unique(role_seniority)) - 1, qs = n()) %>%
  distinct_all()

appropriate <- employees %>%
  group_by(employee_id) %>%
  filter(leadership_for_level == "Appropriate for level") %>%
  summarise(num_appropriate = length(unique(financial_q)))

improvement <- employees %>%
  group_by(employee_id) %>%
  filter(leadership_for_level == "Needs improvement") %>%
  summarise(num_improvement = length(unique(financial_q)))

expectation <- employees %>%
  group_by(employee_id) %>%
  filter(leadership_for_level == "Exceeds expectations") %>%
  summarise(num_expectation = length(unique(financial_q)))

promotion_data <- left_join(promotion_data, appropriate, by="employee_id", keep=FALSE)
promotion_data <- left_join(promotion_data, expectation, by="employee_id", keep=FALSE)
promotion_data <- left_join(promotion_data, improvement, by="employee_id", keep=FALSE)
promotion_data <- promotion_data %>%
  mutate(num_appropriate = replace_na(num_appropriate, 0)) %>%
  mutate(num_expectation = replace_na(num_expectation, 0)) %>%
  mutate(num_improvement = replace_na(num_improvement, 0))

promotion_data
```

## promotion model
### something here (glm(Poisson), ZIP)

* note that there are A LOT OF 0 in num_promotion (variable y), need to either reduce the occurrence of 0 or use ZIP directly.

``` {r count 0, include=TRUE, echo=FALSE, message=FALSE}
# The result shows that nearly half of employees have no promotion
# so we should use ZIP
promotion_data <- promotion_data %>% mutate(no_promotion = num_promotion == 0) %>%
  mutate(no_appropriate = num_appropriate == 0) %>%
  mutate(no_expectation = num_expectation == 0) %>%
  mutate(no_improvement = num_improvement == 0)

promotion_data %>% group_by(no_promotion = num_promotion == 0) %>% count()
promotion_data %>% group_by(no_appropriate) %>% count()
promotion_data %>% group_by(no_expectation) %>% count()
promotion_data %>% group_by(no_improvement) %>% count()

promotion_data
```

```{r zip v1 , include=TRUE, echo=FALSE, message=FALSE}
# fit four models to see which variable to pick
# select m4 because other three models have "system is computational singular" problem

# m1 = zeroinfl(num_promotion~gender + productivity + team + role_seniority, data=promotion_data)
# m2 = zeroinfl(num_promotion~gender + productivity + team, data=promotion_data)
# m3 = zeroinfl(num_promotion~gender + productivity + role_seniority, data=promotion_data)
m4 = zeroinfl(num_promotion~gender + productivity, data=promotion_data)
summary(m4)

# null hypothesis rejected, pick complex model
# choose m1 
m1 = zeroinfl(num_promotion~gender + offset(years_of_service), data=promotion_data)
lrtest(m4, m1)

# has warning: fitted probabilities numerically 0 or 1 occurred
# m5 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_expectation, data=promotion_data)
m6 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement, data=promotion_data)

# null hypothesis rejected, pick complex model
# choose m6
lrtest(m1, m6)

# not use team and role_seniority as conditional effect
# since the null hypothesis may not be rejected and
# it increases the
m7 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement | team, data=promotion_data)
lrtest(m6, m7)
m8 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement | role_seniority, data=promotion_data)
lrtest(m6, m8)
AIC(m6)
AIC(m8)
BIC(m6)
BIC(m8)

m1 = m6
```

```{r zip v2 , include=TRUE, echo=FALSE, message=FALSE}
# add conditional variables and other variables
# conditional variable: estimate proportion of 0 response

# m1 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement, data=promotion_data)
# m2 do not converge
# m2 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_promotion, data=promotion_data)
m3 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_improvement, data=promotion_data)
m4 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_expectation, data=promotion_data)
m5 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement | no_improvement, data=promotion_data)
m6 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement | no_improvement + no_expectation, data=promotion_data)
m7 = zeroinfl(num_promotion~gender + offset(years_of_service) + num_improvement | no_expectation, data=promotion_data)
m8 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_improvement + no_expectation, data=promotion_data)
m9 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_improvement + no_expectation + team, data=promotion_data)
# system is computationally singular: reciprocal condition number = 1.58525e-53FALSE
# m10 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_improvement + no_expectation + team + role_seniority, data=promotion_data)
# system is computationally singular: reciprocal condition number = 1.25807e-36FALSE
# it makes sense to not use "no_appropriate", since only two obervations are not appropriate
# m11 = zeroinfl(num_promotion~gender + offset(years_of_service) | no_improvement + no_expectation +  no_appropriate + team, data=promotion_data)
m12 = zeroinfl(num_promotion~gender + num_improvement + offset(years_of_service) | no_improvement + no_expectation + team, data=promotion_data)
m13 = zeroinfl(num_promotion~gender + num_improvement + num_expectation + offset(years_of_service) | no_improvement + no_expectation + team, data=promotion_data)
m14 = zeroinfl(num_promotion~gender + num_improvement + num_expectation + num_appropriate + offset(years_of_service) | no_improvement + no_expectation + team, data=promotion_data)


lrtest(m1, m3)
lrtest(m1, m4)
lrtest(m3, m5)
lrtest(m5, m6)
lrtest(m6, m8)
lrtest(m8, m9)
# lrtest(m9, m10)
# lrtest(m9, m11)
lrtest(m7, m9)
lrtest(m7, m12)
lrtest(m12, m13)
lrtest(m13, m14)

model_promotion = m14
```

```{r promotion gender, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# test if gender is important for influencing promotion
model_promotion_no_gender = zeroinfl(num_promotion~num_improvement + num_expectation + num_appropriate + offset(years_of_service) | no_improvement + no_expectation + team, data=promotion_data)

# null hypothesis rejected: complex model preferred
# gender may affect the promotion
lrtest(model_promotion_no_gender, model_promotion)

model_promotion_final = model_promotion
```


```{r promotion model summary, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(model_promotion_final)
```

1. model with gender
- first level: $$log(\lambda) = \beta_{10} + \beta_{11} \cdot gender + (\beta_{12} \cdot years\_of\_service + log(s_i))$$, where $$s_i$$ is the offset variable to scale the effect of employment period, $$$lambda$$ is the mean number of promotions per person.
- second level: $$log(\frac{\alpha}{1 - \alpha}) = \beta_{20} + \beta_{21} \cdot no\_improvement + \beta_{22} \cdot no\_expectation$$, where $$\alpha$$ is the probability of someone has no promotions.

2. model without gender
- first level: $$log(\lambda) = \beta_{10} + (\beta_{11} \cdot years\_of\_service + log(s_i))$$, where $$s_i$$ is the offset variable to scale the effect of employment period, $$$lambda$$ is the mean number of promotions per person.
- second level: $$log(\frac{\alpha}{1 - \alpha}) = \beta_{20} + \beta_{21} \cdot no\_improvement + \beta_{22} \cdot no\_expectation$$, where $$\alpha$$ is the probability of someone has no promotions.

## Hiring

Since the output of the model for this section per phase is the result whether a candidate passed this phase, we use the logistic regression here (generalized linear regression model GLM or generalized linear regression mixed model GLMM).

### phase 1

```{r hiring_phase1 v0, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# pass_phase1
# first fit a generalized linear model (GLM) with all variables in the dataset 
# pass_phase1 we genrated, which has data about if someone passes phase 1 of
# AI recuitment pipeline
m1_all_factors <- glm(result ~ gender + team_applied_for + cover_letter + cv + gpa + extracurriculars + work_experience, family=binomial(link=logit), data=pass_phase1)
# summarise the model to see which factors are significant
summary(m1_all_factors)
# now include only significant factors from the complete model
m1_only_sig_factors <- glm(result ~ gender + gpa + extracurriculars + work_experience, family=binomial(link=logit), data=pass_phase1)
summary(m1_only_sig_factors)
# w. r. t. AIC of two models, we prefer the ccomplex one
# null hypothesis rejected, complex model preferred
# so we do not omit other insignificant variables
lrtest(m1_only_sig_factors, m1_all_factors)

m1 = m1_all_factors
```

```{r hiring_phase1 v1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# now we try to use the generalized linear mixed model (GLMM), use team as the grouping unit
m1_grouping <- glmer(result ~ gender + cover_letter + cv + gpa + extracurriculars + work_experience + (1 | team_applied_for), family=binomial(link=logit), data=pass_phase1)
# check the model imformation, the significant variables are the same as GLM version, except gender
summary(m1_grouping)

# fit a GLMM by omitting all insignificant variables of the last model, except gender
m1_grouping_onlysig <- glmer(result ~ gender + gpa + extracurriculars + work_experience + (1 | team_applied_for), family=binomial(link=logit), data=pass_phase1)
summary(m1_grouping_onlysig)

# based on AIC, BIC and lrtest result, we choose one including all parameters
lrtest(m1_grouping_onlysig, m1_grouping)
```

```{r hiring_phase1 v1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# GLM for phase 1:
# AIC = 49.551, BIC = 84.754
# GLMM for phase 1:
# AIC = 50.9, BIC = 86.1
# m1 (GLM) is preferred for slightly less AIC, BIC
BIC(m1)

# fit a new gender without gender, we try to remove gender since it is insignificant
model_phase1_no_gender <- glm(result ~ team_applied_for + cover_letter + cv + gpa + extracurriculars + work_experience, family=binomial(link=logit), data=pass_phase1)
# find info of this model, including AIC and BIC
# AIC = 48.753, BIC = 79.555
summary(model_phase1_no_gender)
BIC(model_phase1_no_gender)

# test result: AIC and BIC of models without gender are lower
# so model without gender is better w.r.t AIC & BIC
# Likelihood Ratio Test: null hypothesis cannot be rejected, reduced model preferred
# so we should use model without gender
lrtest(model_phase1_no_gender, m1)

model_phase1_final = model_phase1_no_gender
```

```{r hiring_phase1 summary, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# summarize the final phase 1 model
# based on the test result above, gender does not impact phase1 result
summary(model_phase1_final)
```

1. model with gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot gender + \beta_2 \cdot team\_applied\_for + \beta_3 \cdot cover\_letter + \beta_4 \cdot cv + \beta_5 \cdot gpa + \beta_6 \cdot extracurriculars + \beta_7 \cdot work\_experience$$, where $$p_i$$ is the probability of passing phase 1 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.
2. model without gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot team\_applied\_for + \beta_2 \cdot cover\_letter + \beta_3 \cdot cv + \beta_4 \cdot gpa + \beta_5 \cdot extracurriculars + \beta_6 \cdot work\_experience$$, where $$p_i$$ is the probability of passing phase 1 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.

### phase 2

```{r hiring_phase2 v0, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# pass_phase2
# first fit a generalized linear model (GLM) with all variables in the dataset 
# pass_phase2 we genrated, which has data about if someone passes phase 2 of
# AI recuitment pipeline
m2_all_factors <- glm(result ~ gender + technical_skills + writing_skills + speaking_skills + leadership_presence, family=binomial(link=logit), data=pass_phase2)
# summarise the model to see which factors are significant
# result: all factors are significant except for gender
summary(m2_all_factors)

m2 = m2_all_factors
BIC(m2)
```


```{r hiring_phase2 v1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# fit a new model for phase 2
# every parameters are the same as m2_all_factors except for omitting gender
m2_no_gender <- glm(result ~ technical_skills + writing_skills + speaking_skills + leadership_presence, family=binomial(link=logit), data=pass_phase2)
# get the info of the model
# m2_no_gender:
# AIC = 79.877, BIC = 98.34566
# m2:
# AIC = 81.247, BIC = 103.4098
# the reduced model has lower slightly AIC and BIC
# so m2_no_gender is preferred w.r.t. AIC & BIC
BIC(m2_no_gender)
summary(m2_no_gender)

# test result: the null hypothesis cannot be rejected
# so we prefer to use the reduced model (gender is not needed)
lrtest(m2_no_gender, m2)

model_phase2_final = m2_no_gender
```

```{r hiring_phase2 summary, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# summarize the final phase 2 model
# based on the test result above, gender does not impact phase2 result
summary(model_phase2_final)
```

1. model with gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot gender + \beta_2 \cdot technical\_skills + \beta_3 \cdot writing\_skills + \beta_4 \cdot speaking\_skills + \beta_5 \cdot leadership\_presence$$, where $$p_i$$ is the probability of passing phase 2 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.
2. model without gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot technical\_skills + \beta_2 \cdot writing\_skills + \beta_3 \cdot speaking\_skills + \beta_4 \cdot leadership\_presence$$, where $$p_i$$ is the probability of passing phase 2 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.


### Phase 3

```{r hiring_phase3 v0, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# pass_phase3
# first fit a generalized linear model (GLM) with all variables in the dataset 
# pass_final we genrated, which has data about if someone passes phase 3 of
# AI recuitment pipeline and finally get hired
m3_all_factors <- glm(result ~ gender + interviewer_rating_1 + interviewer_rating_2, family=binomial(link=logit), data=pass_final)
# summarise the model to see which factors are significant
# result: all factors are significant except for gender
summary(m3_all_factors)

m3 = m3_all_factors
BIC(m3)
```


```{r hiring_phase3 v1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# fit a new model for phase 3
# every parameters are the same as m3_all_factors except for omitting gender
m3_no_gender <- glm(result ~ interviewer_rating_1 + interviewer_rating_2, family=binomial(link=logit), data=pass_final)
# get the info of the model
# m3_no_gender:
# AIC = 6, BIC = 9.273127
# m3:
# AIC = 8, BIC = 12.36417
# the reduced model has lower slightly AIC and BIC
# so m3_no_gender is preferred w.r.t. AIC & BIC
BIC(m3_no_gender)
summary(m3_no_gender)

# test result: the null hypothesis cannot be rejected
# so we prefer to use the reduced model (gender is not needed)
lrtest(m3_no_gender, m3)

model_phase3_final = m3_no_gender
```


```{r hiring_phase3 summary, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# summarize the final phase 3 model
# based on the test result above, gender does not impact phase3 result
summary(model_phase3_final)
```


1. model with gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot gender + \beta_2 \cdot interviewer\_rating\_1 + \beta_3 \cdot interviewer\_rating\_2$$, where $$p_i$$ is the probability of passing phase 2 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.
2. model without gender
$$log(\frac{p_i}{1 - p_i}) = \beta_0 + \beta_1 \cdot interviewer\_rating\_1 + \beta_2 \cdot interviewer\_rating\_2$$, where $$p_i$$ is the probability of passing phase 2 for observer $$i$$, and $$result \sim Binomial(n_i, p_i)$$.


```{r all variables1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# we combine all parameters from all phases together to see if gender impacts the final result
# NOTE: do not use this model for predicting the result through all phases, since if a candidate
# cannot pass one phase, then he will have no values for variables from next phases (so the value is NA)
# first let's fit a GLM
allphase = allphase %>%
  mutate(if_hired = ifelse(status=="hired", 1, 0))

all_m3 = glm(if_hired ~ gender + team_applied_for + cover_letter + cv + gpa + extracurriculars + work_experience + technical_skills + writing_skills + speaking_skills + leadership_presence + interviewer_rating_1 + interviewer_rating_2, family=binomial(link=logit), data=allphase)

all_m3_no_gender = glm(if_hired ~ team_applied_for + cover_letter + cv + gpa + extracurriculars + work_experience + technical_skills + writing_skills + speaking_skills + leadership_presence + interviewer_rating_1 + interviewer_rating_2, family=binomial(link=logit), data=allphase)

summary(all_m3)
summary(all_m3_no_gender)

# test result: null hypothesis cannot be rejected, so reduced model is preferred
# gender does not impact
# based on the p-value (1), the reduced model is strongly preferred indeed
lrtest(all_m3_no_gender, all_m3)
```

### Consider model the whole recruiment process
__NOTE__: do not use the models built in this section, please use the per-phase models built above to do the real analysis

```{r all variables1, include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# we use GLMM now instead of GLM to check whether gender impacts
# NOTE: do not use this model for predicting the result through all phases, since if a candidate
# cannot pass one phase, then he will have no values for variables from next phases (so the value is NA)

all_m3_mixed = glmer(if_hired ~ gender + cover_letter + cv + gpa + extracurriculars + work_experience + technical_skills + writing_skills + speaking_skills + leadership_presence + interviewer_rating_1 + interviewer_rating_2 + (1 | team_applied_for), family=binomial(link=logit), data=allphase, nAGQ=0)

all_m3_no_gender_mixed = glmer(if_hired ~  cover_letter + cv + gpa + extracurriculars + work_experience + technical_skills + writing_skills + speaking_skills + leadership_presence + interviewer_rating_1 + interviewer_rating_2 + (1 | team_applied_for), family=binomial(link=logit), data=allphase, nAGQ=0)

summary(all_m3_mixed)
summary(all_m3_no_gender_mixed)

# test result: null hypothesis cannot be rejected, so reduced model is preferred
# gender does not impact
# based on the p-value (1), the reduced model is strongly preferred indeed
lrtest(all_m3_no_gender_mixed, all_m3_mixed)
```

Therefore, no matter for passing each phase of the recruitment, all cconsidering for the whole recruitment process, there is no discrimination for hiring powered by this AI technology.

## Note

```{r, include=FALSE}
# save your file
#ggsave("images/example.png", width=7, height=4)


# use image outside the chunck
# ![](file/path.png)
```
